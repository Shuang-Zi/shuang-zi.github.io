<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="苍穹录" href="http://yoursite.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="苍穹录" href="http://yoursite.com/atom.xml"><link rel="alternate" type="application/json" title="苍穹录" href="http://yoursite.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="http://yoursite.com/Perfetto/"><title>Perfetto | 双子红械 = 苍穹录 = Sky Records</title><meta name="generator" content="Hexo 6.0.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Perfetto</h1><div class="meta"><span class="item" title="创建时间：2022-06-12 18:19:44"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-06-12T18:19:44+08:00">2022-06-12</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>11k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>10 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">双子红械</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://c2.im5i.com/2022/09/12/52tn1.jpg"></li><li class="item" data-background-image="https://c2.im5i.com/2022/09/12/522bD.jpg"></li><li class="item" data-background-image="https://c2.im5i.com/2022/09/12/52XNP.jpg"></li><li class="item" data-background-image="https://c2.im5i.com/2022/09/12/52YhS.jpg"></li><li class="item" data-background-image="https://c2.im5i.com/2022/09/12/529mj.jpg"></li><li class="item" data-background-image="https://c2.im5i.com/2022/09/12/52ZVm.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://yoursite.com/Perfetto/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Yang"><meta itemprop="description" content="Sky Records, 合抱之木，生于毫末；九层之塔，起于垒土。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="苍穹录"></span><div class="body md" itemprop="articleBody"><h1 id="perfetto性能分析工具"><a class="anchor" href="#perfetto性能分析工具">#</a> Perfetto 性能分析工具</h1><h1 id="1-简介"><a class="anchor" href="#1-简介">#</a> 1. 简介</h1><p>Perfetto 工具是 Android 下一代全新的跨平台 trace 收集和分析框架，可以抓取平台和 app 的跟踪信息。</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/Screenshot_2021-03-04_Perfetto_-_System_profiling_app_tracing_and_trace_analysis.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/Screenshot_2021-03-04_Perfetto_-_System_profiling_app_tracing_and_trace_analysis.png"></p><p>除此之外，Perfetto 还提供一个跟踪可视化工具，基于 web 平台。可以在<span class="exturl" data-url="aHR0cHM6Ly91aS5wZXJmZXR0by5kZXYvIyEv"> https://ui.perfetto.dev/#!/</span> 打开追踪后产生的文件，就可以直观地浏览跟踪信息，界面如下所示：</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/Screenshot_2021-03-04_trace_protobuf_(1_MB)_-_Perfetto_UI.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/Screenshot_2021-03-04_trace_protobuf_(1_MB)_-_Perfetto_UI.png"></p><blockquote><p>关于 ui 界面的详细操作技巧介绍：<span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy92aXN1YWxpemF0aW9uL3BlcmZldHRvLXVp">https://perfetto.dev/docs/visualization/perfetto-ui</span></p></blockquote><h1 id="2-构建perfetto"><a class="anchor" href="#2-构建perfetto">#</a> 2. 构建 Perfetto</h1><ol><li>从 git 上下载源代码：</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">git</span> clone https://android.googlesource.com/platform/external/perfetto/ <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> perfetto</pre></td></tr></table></figure><ol start="2"><li>下载并提取依赖项：</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>tools/install-build-deps</pre></td></tr></table></figure><ol start="3"><li>生成所有最常见的 GN 构建配置：</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>tools/build_all_configs.py</pre></td></tr></table></figure><ol start="4"><li>构建 Linux 跟踪二进制文件：</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>tools/ninja -C out/linux_clang_release traced traced_probes perfetto</pre></td></tr></table></figure><blockquote><p><em>使用 tools/tmux 下面的脚本时，此步骤是可选的.</em></p></blockquote><h1 id="3-测试perfetto"><a class="anchor" href="#3-测试perfetto">#</a> 3. 测试 Perfetto</h1><blockquote><p><em>不是必要的</em></p></blockquote><h2 id="31-一键式-tmux-脚本"><a class="anchor" href="#31-一键式-tmux-脚本">#</a> 3.1 一键式 tmux 脚本</h2><p>在 Perfetto 目录下，执行：</p><p><code>OUT=out/linux_clang_release CONFIG=test/configs/scheduling.cfg tools/tmux -n</code></p><p>perfetto 为我们提供了 tools/tmux 脚本，它负责构建，设置和运行所有内容。作为示例，让我们看一下进程调度数据，该数据将从 Linux 内核通过 ftrace 接口获得。</p><blockquote><p>perfetto CLI (命令行) 工具运行时候，需要制定 config 文件，perfetto 默认为我们提供了多个配置模板，位于仓库路径下 test/configs 目录下.<br>上面我们使用的是默认提供的 scheduling 的配置，我们也可以自定义 config 或者用 perfeto ui 生成 config.</p></blockquote><p>脚本首先将我们需要的服务程序和 perfetto CLI 工具及其依赖库都拷贝到了 TMP 目录下</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>/tmp/perfetto.xxxxxx</pre></td></tr></table></figure><p>然后使用 tmux 帮我们打开了一个有三个面板的 tmux 窗口，从上往下分别启动了: traced, traced_probes 和 perfetto 抓取日志的工作台.</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-16_15-37-33_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-16_15-37-33_.png"></p><p>在最底下的 perfetto 工作面板中，已经为我们预先填好了抓取 perfetto 的命令，我们只需要回车就可以抓取 10S 调度日志.</p><blockquote><p>使用 tmux kill-session -t demo. 直接关闭这个会话。</p></blockquote><p>结束后，脚本会将跟踪到的信息放在 /tmp/trace.protobuf 里，使用<span class="exturl" data-url="aHR0cHM6Ly91aS5wZXJmZXR0by5kZXYvIyEv"> perfetto ui</span> 直接打开这个文件就行了。</p><h2 id="32-手动运行服务"><a class="anchor" href="#32-手动运行服务">#</a> 3.2 手动运行服务</h2><p>前面使用 tmux 运行了之后，我们就清楚的知道启动了那些服务，以及 perfetto 抓取的命令.</p><p>手动将服务后台启起来，然后运行 perfetto, 指定 trace config, 抓取 trace 日志.</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> out/linux_clang_debug</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>./traced_probes <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>./traced <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>./perfetto --txt -c <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/test/configs/scheduling.cfg  -o trace</pre></td></tr></table></figure><h1 id="4-使用perfetto"><a class="anchor" href="#4-使用perfetto">#</a> 4. 使用 Perfetto</h1><p>perfetto 是一个命令行工具，在 shell 环境下执行，他依赖于系统中运行的的两个服务进程 traced 和 traced_probes 来完成工作.</p><p>Android 通过启用 perfetto 服务来自动运行 traced (会话守护程序 - taced 服务) 和 traced_probes (探测和 ftrace-interop 守护程序).</p><p>但是 Linux 系统中我们必须手动将这两个服务启动起来.</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/Screenshot_2021-03-04_Service-based_model_-_Perfetto_Tracing_Docs.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/Screenshot_2021-03-04_Service-based_model_-_Perfetto_Tracing_Docs.png"></p><ul><li><p>这里是关于生产者 (producer)，消费者 (consumer) 以及服务 (tracing service) 在跟踪会话 (tracing session) 期间如何交互的文档，可以结合上边的图片和下边的文档一起看，这样比较容易理解。为防止歧义，这里直接放<span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy9kZXNpZ24tZG9jcy9saWZlLW9mLWEtdHJhY2luZy1zZXNzaW9u">官方文档</span>。</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-09_20-16-35_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-09_20-16-35_.png"></p></li></ul><blockquote><p>说明：以下操作均在～/perfetto/out/linux_clang_release 或者～/perfetto/out/linux_clang_debug 目录下。<br>在 debug 目录下启动的话，服务启动时的各种信息很详细。</p></blockquote><blockquote><p>在个人程序中初始化 perfetto 的时候，如果选择进程内 (in-process) 模式，直接启动程序就行，不需要启动 1 和 2 两个服务。详情见下文。</p></blockquote><ul><li><p>初始化 Perfetto 时的两种模式</p><p>两种模式不是互斥的。可以将应用程序配置为在两种模式下都可以工作，并同时响应进程内跟踪请求和系统跟踪请求。两种模式都生成相同的跟踪文件格式。</p><ol><li>进程内模式</li></ol><p>在这种模式下，perfetto 服务和应用程序定义的数据源都完全托管在进程内，只关心进程内的信息，不会尝试与系统跟踪的守护程序 (traced service) 建立连接。</p><p>初始化 SDK 时，可以通过设置</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>TracingInitArgs<span class="token punctuation">.</span>backends<span class="token operator">=</span>perfetto<span class="token double-colon punctuation">::</span>kInProcessBackend</pre></td></tr></table></figure><p>来启用进程内模式。</p><p>此模式用于生成仅包含应用程序发出的事件，而不包含其他类型的事件的跟踪，它的主要优点在于不需要任何特殊的 OS 特权，并且程序可以控制跟踪会话的生命周期。</p><p>举个例子：</p><p>在以下路径中，运行 <code>./example</code></p><p><code>～/perfetto/examples/sdk/build</code></p><p>不需要启动其他服务，直接就开始追踪信息，并创建了一个追踪信息文件在当前目录下。</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-05_13-52-14_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-05_13-52-14_.png"></p><p><code>example.cc</code> 文件在上一层目录下，或者可以直接猛击这个链接<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by9leGFtcGxlcy9zZGsvZXhhbXBsZS5jYzticHY9MA==">查看其代码</span>。</p><ul><li><p>进程内模式下记录追踪的一系列 API</p><p>可以查看这个文档<span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy9pbnN0cnVtZW50YXRpb24vdHJhY2luZy1zZGsjcmVjb3JkaW5n"> https://perfetto.dev/docs/instrumentation/tracing-sdk#recording</span></p></li></ul><ol start="2"><li>系统模式</li></ol><p>在这种模式下，应用程序定义的数据源将使用 UNIX 套接字上的 IPC 连接到外部跟踪服务 traced service。</p><p>初始化 SDK 时，可以通过设置</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>TracingInitArgs<span class="token punctuation">.</span>backends <span class="token operator">=</span> perfetto <span class="token double-colon punctuation">::</span> kSystemBackend</pre></td></tr></table></figure><p>来启用系统模式。</p><p>此模式的主要优点是可以创建融合的跟踪，在这些跟踪中，应用程序事件将覆盖在操作系统事件的同一时间轴上。这样就可以进行全栈性能调查，从头到尾查看系统调用和内核调度事件。</p><p>该模式的主要局限性在于，它要求外部跟踪守护程序启动并运行，并且可以通过 UNIX 套接字连接访问。</p><p>使用系统模式时，必须使用 perfetto 命令行客户端（command-line）从外部控制跟踪会话。这是因为在收集系统跟踪信息时，不允许跟踪数据生产者回读跟踪数据，因为它可能会泄露有关其他进程的信息。</p><p>这个模式也有例子 <code>example_system_wide.cc</code></p><p>也可以直接猛击<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by9leGFtcGxlcy9zZGsvZXhhbXBsZV9zeXN0ZW1fd2lkZS5jYzticHY9MA==">这里</span>查看其代码。</p></li></ul><h2 id="1-启动traced-service"><a class="anchor" href="#1-启动traced-service">#</a> 1. 启动 traced service</h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./traced</pre></td></tr></table></figure><h3 id="11-描述"><a class="anchor" href="#11-描述">#</a> 1.1 描述：</h3><ul><li><strong>traced service</strong> 充当配置调度程序：它从 perfetto cmdline 客户端（或任何其他 Consumer）接收配置，并将配置的一部分转发给连接的各个生产者。当使用者启动跟踪会话时，跟踪服务将：<ol><li>读取 TraceConfig 中的信息（例如 duration_ms，缓冲区），然后使用该部分来确定其自身的行为。</li><li>读取 TraceConfig 中 data_sources 部分中的数据源列表。如果生产者注册了对应的名字，要求生产者启动该数据源，将 DataSourceConfig 的原始字节逐字传递给数据源。</li></ol></li></ul><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-08_16-35-20_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-08_16-35-20_.png"></p><ul><li><p>关于 TraceConfig 的详细信息:</p><ul><li><p>与许多始终在线的日志记录系统（例如 Linux 的 rsyslog，Android 的 logcat）不同 Perfetto 中的所有跟踪数据源默认情况下都是空闲的，并且仅在指示时才记录数据。</p></li><li><p>数据源仅在一个（或多个）跟踪会话处于活动状态时才记录数据。 通过调用 perfetto cmdline 客户端并传递配置 (trace config) 来启动跟踪会话 (tracing session)</p></li><li><p>以下是一个 trace config 文件的简单示例：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>duration_ms<span class="token operator">:</span> <span class="token number">10000</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>buffers <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  size_kb<span class="token operator">:</span> <span class="token number">65536</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  fill_policy<span class="token operator">:</span> RING_BUFFER</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>data_sources <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  config <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    name<span class="token operator">:</span> <span class="token string">"track_event"</span>     <span class="token comment">// 这个名字是唯一的</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    target_buffer<span class="token operator">:</span> <span class="token number">0</span>        <span class="token comment">// 该数据源将写入数据到 buffer 0</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    track_event_config <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        enabled_categories<span class="token operator">:</span> <span class="token string">"rendering"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>如果想看更多示例，请点击<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by90ZXN0L2NvbmZpZ3MvO2Jwdj0w">这里</span>。</p></blockquote><p>上边 data_sources 中的 name 是唯一的，不可随意更改。官方已经设置了名字，如下图：</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-16_16-25-37_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-16_16-25-37_.png"></p><p>还有许多数据源也都定义了名字，具体看<span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy9yZWZlcmVuY2UvdHJhY2UtY29uZmlnLXByb3RvI0RhdGFTb3VyY2VDb25maWc=">这里</span>。</p></li><li><p>Trace Config 的各种详细的选项，请看这里的<span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy9yZWZlcmVuY2UvdHJhY2UtY29uZmlnLXByb3Rv">参考文档</span>。总体来说 TraceConfig 里分为三个部分：</p><ol><li>整个跟踪系统的一般行为，例如：<ul><li>跟踪的最大持续时间，duration_ms</li><li>内存中缓冲区的数量及其大小，还有策略 (fill_policy)。<ul><li><p>跟踪配置必须定义至少一个有效缓冲区。 在最简单的情况下，所有数据源都会将其跟踪数据写入同一缓冲区。</p><p>但是当两种数据源写入数据的速率差异很大时，最好将它们的目标缓冲区分开，这里就用到 TraceConfig 的 target_buffer 字段来实现。</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-08_16-54-37_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-08_16-54-37_.png"></p></li><li><p>每个缓冲区都有一个填充策略，该策略可以是：</p><ol><li>RING_BUFFER (default): 缓冲区的行为类似于环形缓冲区。</li><li>DISCARD：一旦满，缓冲区将停止接受数据。 进一步的写尝试将被丢弃。</li></ol></li></ul></li></ul></li><li>启用哪些数据源及其配置。Tracking driver memory usage events</li><li>每个数据源应写入哪个缓冲区。</li></ol></li></ul></li><li><p>如果要抓取长时间追踪信息，看这里</p><p>由于默认情况下 Perfetto 会将完整的跟踪缓冲区保留在内存中，并且仅在跟踪会话结束时才将其写入目标文件。但是，这将跟踪的最大大小限制为设备的物理内存大小，而这通常过于局限。我们可以使用以下 TraceConfig 字段将跟踪缓冲区定期写入目标文件：</p><ol><li>设置 write_into_file:true</li><li>设置一个长的 duration_ms 时间。</li><li>使用 32MB 或更大的内存缓冲区大小。</li></ol><p>可以参考这个例子 <span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by90ZXN0L2NvbmZpZ3MvbG9uZ190cmFjZS5jZmc=">long_trace.cfg</span>。</p></li><li><p>关于多进程指定同一数据源的情况：</p><p>如果发生这种情况，在启动在跟踪配置中指定该数据源的跟踪会话（consumer）时，默认情况下，Perfetto 将要求发布该数据源的所有进程启动它。</p><blockquote><p>注意：典型的 Perfetto 运行时模型是：一个进程 == 一个 Perfetto 生产者； 一个生产者通常托管多个数据源。</p></blockquote><p>我们可以通过在配置文件中设置过滤器，将数据源的启用限制为特定的过程。这可以通过 producer_name_filter 和 producer_name_regex_filter 来实现。</p><p>当设置这些筛选器时，跟踪服务只会在匹配筛选器的生产者子集中激活数据源。</p><p>举个例子：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>data_sources <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  config <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    name<span class="token operator">:</span> <span class="token string">"track_event"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Enable the data source only on Chrome <span class="token operator">and</span> Chrome canary<span class="token punctuation">.</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>  producer_name_filter<span class="token operator">:</span> <span class="token string">"com.android.chrome"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  producer_name_filter<span class="token operator">:</span> <span class="token string">"com.google.chrome.canary"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ul><h3 id="12-它具有以下功能"><a class="anchor" href="#12-它具有以下功能">#</a> 1.2 它具有以下功能</h3><ul><li>维护 producer 及其数据源的注册表。</li><li>拥有跟踪缓冲区。（trace buffer）</li><li>处理多个跟踪会话 (trace session) 的多路复用。</li><li>将 trace config 从使用者传送到相应的生产者。告诉生产者何时何地进行追踪。</li><li>将数据从生产者的共享内存缓冲区移动到中央非共享跟踪缓冲区。</li></ul><p><span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy9pbWFnZXMvZGF0YWZsb3cuc3Zn"></span></p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/dataflow.svg" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/dataflow.svg"></p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/dataflow%201.svg" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/dataflow%201.svg"></p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/dataflow%202.svg" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/dataflow%202.svg"></p><p>以下这张图是在 linux_clang_debug 目录下启动 traced 服务的详细信息：</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-16_17-47-03_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-16_17-47-03_.png"></p><p>图中，Producer1 和 2 都是服务自己启动的，自动注册了大部分的数据源。</p><p>当我们自己的程序启动时，会连接这个服务，如图中有 &quot;Producer 3 connected&quot; 这句话。</p><p>接着注册了 “track_event”（只有这个数据源是我们自己注册的）。</p><p>接着通过 pefetto 命令行启动了 consumer ，提示”consumer .... connected“。</p><p>之后的，就都是服务创建共享内存，读取 trace config 里的信息，激活对应数据源等等。</p><h2 id="2-启动-traced_probes"><a class="anchor" href="#2-启动-traced_probes">#</a> 2. 启动 traced_probes</h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./traced_probes</pre></td></tr></table></figure><p>有权访问内核的特权守护程序。它驱动 Ftrace 并将其经过 protobuf 转换的内容写入到 trace 文件中。</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2962707-908158959aea7fce.jpg" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2962707-908158959aea7fce.jpg"></p><h2 id="3-启动你的程序"><a class="anchor" href="#3-启动你的程序">#</a> 3. 启动你的程序</h2><p><code>./test</code> （这个在自己程序所在的目录下运行。）</p><h3 id="31-程序编写读的时候可以参考这里"><a class="anchor" href="#31-程序编写读的时候可以参考这里">#</a> 3.1 程序编写（读的时候可以参考<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by9leGFtcGxlcy9zZGsvZXhhbXBsZV9zeXN0ZW1fd2lkZS5jYzticHY9MA==">这里</span>）</h3><ol><li>首先，在程序入口 (main) 中初始化 Perfetto：</li></ol><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">InitializePerfetto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//InitializePerfetto () 实现如下：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">InitializePerfetto</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	perfetto<span class="token double-colon punctuation">::</span>TracingInitArgs args<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 选择系统内模式，记录跟踪事件</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">// 共有两种模式可供选择，详见下文</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	args<span class="token punctuation">.</span>backends <span class="token operator">=</span> perfetto<span class="token double-colon punctuation">::</span>kSystemBackend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">Tracing</span><span class="token double-colon punctuation">::</span><span class="token function">Initialize</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">TrackEvent</span><span class="token double-colon punctuation">::</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol start="2"><li>实例化 Observer 观察者，等待追踪会话启动（实际上就是 consumer），防止跟踪点丢失。</li></ol><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>Observer observer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>observer<span class="token punctuation">.</span><span class="token function">WaitForTracingStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>Observer 类的详细如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">TrackEventSessionObserver</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token function">Observer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">TrackEvent</span><span class="token double-colon punctuation">::</span><span class="token function">AddSessionObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token operator">~</span><span class="token function">Observer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">TrackEvent</span><span class="token double-colon punctuation">::</span><span class="token function">RemoveSessionObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token keyword">const</span> perfetto<span class="token double-colon punctuation">::</span>DataSourceBase<span class="token double-colon punctuation">::</span>StartArgs<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">WaitForTracingStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">PERFETTO_LOG</span><span class="token punctuation">(</span><span class="token string">"Waiting for tracing to start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">TrackEvent</span><span class="token double-colon punctuation">::</span><span class="token function">IsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">PERFETTO_LOG</span><span class="token punctuation">(</span><span class="token string">"Tracing started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  std<span class="token double-colon punctuation">::</span>mutex mutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li><ol start="3"><li>在功能函数中添加 Track events</li></ol><ul><li><p>关于 Track events 的详细介绍</p><p>为防止歧义，以下直接使用官方文档。如果想看详细信息，这是链接<span class="exturl" data-url="aHR0cHM6Ly9wZXJmZXR0by5kZXYvZG9jcy9pbnN0cnVtZW50YXRpb24vdHJhY2stZXZlbnRz"> https://perfetto.dev/docs/instrumentation/track-events</span></p><ol><li>简介：Track events are application specific, time bounded events recorded into a trace while the application is running. Track events are always associated with a track, which is a timeline of monotonically increasing time. A track corresponds to an independent sequence of execution, such as a single thread in a process.</li><li>track events 的几种主要的类型：<ol><li><p>Slices，which represent nested, time bounded operations. For example, a slice could cover the time period from when a function begins executing to when it returns, the time spent loading a file from the network or the time to complete a user journey.</p></li><li><p>Counters, which are snapshots of time-varying numeric values. For example, a track event can record instantaneous the memory usage of a process during its execution.</p><ul><li><p>Counters 详解</p><p>Counters 可以被以下宏创建：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">TRACE_COUNTER1</span><span class="token punctuation">(</span>category_group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 立即创建一个名为 name 的计数器。</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//value 必须表示为 32 位的整数。</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 类别和名字字符串的生命周期存在于整个进程运行期间，</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 这就是为什么给它们声明为静态存储。</span></pre></td></tr></table></figure><p>计数器是特定于进程的。 但是，宏本身可以从任何线程调用。</p><p>如果你想同时追踪两个计数器，你可以这样：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 1. 调用两次计数器宏，例如</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">TRACE_COUNTER1</span><span class="token punctuation">(</span><span class="token string">"MY_SUBSYSTEM"</span><span class="token punctuation">,</span> <span class="token string">"myCounter0"</span><span class="token punctuation">,</span> g_myCounterValue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">TRACE_COUNTER1</span><span class="token punctuation">(</span><span class="token string">"MY_SUBSYSTEM"</span><span class="token punctuation">,</span> <span class="token string">"myCounter1"</span><span class="token punctuation">,</span> g_myCounterValue<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 2. 调用一个组合宏，例如：</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">TRACE_COUNTER2</span><span class="token punctuation">(</span><span class="token string">"MY_SUBSYSTEM"</span><span class="token punctuation">,</span> <span class="token string">"myCounter"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>				<span class="token string">"bytesPinned"</span><span class="token punctuation">,</span> g_myCounterValue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"bytesAllocated"</span><span class="token punctuation">,</span> g_myCounterValue<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>由于 Counters 位于全局命名空间中，所以你如果想要消除歧义（如果两个计数器使用了同眼样的名字），可以使用 <code>TRACE_COUNTER_ID*</code> 宏给它一个唯一的 ID。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">*</span><span class="token operator">*</span><span class="token function">TRACE_COUNTER_ID1</span><span class="token punctuation">(</span>category_group<span class="token punctuation">,</span> name<span class="token punctuation">,</span> id<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//id 必须是指针或最多 64 位的整数值。</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 如果是指针，那么这些位将与进程 ID 的散列进行异或运算，</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 这样两个不同进程上的同一指针就不会发生冲突。**</span></pre></td></tr></table></figure></li></ul></li><li><p>Flows, which are used to connect related slices that span different tracks together. For example, if an image file is first loaded from the network and then decoded on a thread pool, a flow event can be used to highlight its path through the system. (Not fully implemented yet).</p></li></ol></li></ol></li></ul><ol><li><p>在头文件中添加追踪事件类别列表，<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by9leGFtcGxlcy9zZGsvdHJhY2VfY2F0ZWdvcmllcy5oO2Jwdj0w">举个例子</span>。</p></li><li><p>接着在.cc 文件中为事件类别声明静态存储， <code>PERFETTO_TRACK_EVENT_STATIC_STORAGE()；</code></p></li></ol><p>注：示例中是新建了一个另外的文件来声明，点击<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpleHRlcm5hbC9wZXJmZXR0by9leGFtcGxlcy9zZGsvdHJhY2VfY2F0ZWdvcmllcy5jYzticHY9MA==">这里</span>查看。除此之外，也可以直接在主 cc 文件开头声明。</p><blockquote><p>这是一个在 perfetto.h 文件中定义的一个宏，主要为每个事件类别分配存储空间，详细如下：</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Allocate storage for each category by using this macro once per track event</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// namespace.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PERFETTO_TRACK_EVENT_STATIC_STORAGE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>      </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token expression"><span class="token keyword">namespace</span> PERFETTO_TRACK_EVENT_NAMESPACE <span class="token punctuation">&#123;</span>       </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token expression"><span class="token function">PERFETTO_INTERNAL_CATEGORY_STORAGE</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token expression"><span class="token punctuation">&#125;</span> </span><span class="token comment">/* namespace PERFETTO_TRACK_EVENT_NAMESPACE */</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token expression"><span class="token function">PERFETTO_DEFINE_DATA_SOURCE_STATIC_MEMBERS</span><span class="token punctuation">(</span>      </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token expression">PERFETTO_TRACK_EVENT_NAMESPACE<span class="token double-colon punctuation">::</span>TrackEvent<span class="token punctuation">,</span>  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token expression">perfetto<span class="token double-colon punctuation">::</span>internal<span class="token double-colon punctuation">::</span>TrackEventDataSourceTraits<span class="token punctuation">)</span></span></pre></td></tr></table></figure><ol start="3"><li>初始化事件，其实在上边初始化 perfetto 的时候已经做了。</li></ol><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">Tracing</span><span class="token double-colon punctuation">::</span><span class="token function">Initialize</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  perfetto<span class="token double-colon punctuation">::</span><span class="token class-name">TrackEvent</span><span class="token double-colon punctuation">::</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Add this.</span></pre></td></tr></table></figure><p>现在，你可以在功能函数里添加事件了，像这样：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">DrawPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token function">TRACE_EVENT</span><span class="token punctuation">(</span><span class="token string">"rendering"</span><span class="token punctuation">,</span> <span class="token string">"DrawPlayer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Begin "DrawPlayer" slice.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// End "DrawPlayer" slice.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 这种类型的跟踪事件是作用域内的，它使用 C ++ RAII 进行了内部监视。 </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 该事件将覆盖从遇到 TRACE_EVENT 注释到块结束（在上面的示例中，直到函数返回）之间的时间。</span></pre></td></tr></table></figure><ul><li><p>TRACE_EVENT 也是在 perfetto.h 定义的一个宏，具体如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Begin a slice which gets automatically closed when going out of scope.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TRACE_EVENT</span><span class="token expression"><span class="token punctuation">(</span>category<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token expression"><span class="token function">PERFETTO_INTERNAL_SCOPED_TRACK_EVENT</span><span class="token punctuation">(</span>category<span class="token punctuation">,</span> name<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></pre></td></tr></table></figure><blockquote><p>对于不遵循函数作用域的事件，请使用 TRACE_EVENT_BEGIN 和 TRACE_EVENT_END：</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">DrawPlayer</span><span class="token punctuation">(</span><span class="token keyword">int</span> player_number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 您还可以随事件提供（最多两个）调试注释。</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token function">TRACE_EVENT</span><span class="token punctuation">(</span><span class="token string">"rendering"</span><span class="token punctuation">,</span> <span class="token string">"DrawPlayer"</span><span class="token punctuation">,</span> <span class="token string">"player_number"</span><span class="token punctuation">,</span> player_number<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// Sleep to simulate a long computation.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">void</span> <span class="token function">DrawGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// This is an example of an unscoped slice, which begins and ends at specific</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// points (instead of at the end of the current block scope).</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">TRACE_EVENT_BEGIN</span><span class="token punctuation">(</span><span class="token string">"rendering"</span><span class="token punctuation">,</span> <span class="token string">"DrawGame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">DrawPlayer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">DrawPlayer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">TRACE_EVENT_END</span><span class="token punctuation">(</span><span class="token string">"rendering"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 在 perfetto.h 中的宏定义</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TRACE_EVENT_BEGIN</span><span class="token expression"><span class="token punctuation">(</span>category<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>    </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token expression"><span class="token function">PERFETTO_INTERNAL_TRACK_EVENT</span><span class="token punctuation">(</span>                  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token expression">category<span class="token punctuation">,</span> <span class="token function">PERFETTO_GET_STATIC_STRING</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token expression"><span class="token double-colon punctuation">::</span>perfetto<span class="token double-colon punctuation">::</span>protos<span class="token double-colon punctuation">::</span>pbzero<span class="token double-colon punctuation">::</span>TrackEvent<span class="token double-colon punctuation">::</span>TYPE_SLICE_BEGIN<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// End a slice under |category|.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TRACE_EVENT_END</span><span class="token expression"><span class="token punctuation">(</span>category<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token expression"><span class="token function">PERFETTO_INTERNAL_TRACK_EVENT</span><span class="token punctuation">(</span>       </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token expression">category<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token expression"><span class="token double-colon punctuation">::</span>perfetto<span class="token double-colon punctuation">::</span>protos<span class="token double-colon punctuation">::</span>pbzero<span class="token double-colon punctuation">::</span>TrackEvent<span class="token double-colon punctuation">::</span>TYPE_SLICE_END<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 注意：您无需为 TRACE_EVENT_END 命名，因为它会自动关闭从同一线程开始的最近事件。</span></pre></td></tr></table></figure></li></ul></li></ul><ol start="4"><li>刷新缓冲区，以确保追踪数据不会丢失</li></ol><p><code>perfetto::TrackEvent::Flush();</code></p><h2 id="4-启动consumer"><a class="anchor" href="#4-启动consumer">#</a> 4. 启动 Consumer</h2><h3 id="41-描述"><a class="anchor" href="#41-描述">#</a> 4.1 描述</h3><p><strong>Consumer</strong> 在整个框架中是一个使用者的角色，通过 perfetto 命令行客户端开启跟踪会话（trace session）启动。它来控制跟踪服务（tracing service）行为，并且从 trace buffers 中读取数据，详细功能如下：</p><ul><li>将跟踪配置 (trace config) 发送到服务：<ul><li>要创建多少跟踪缓冲区。</li><li>跟踪缓冲区应该有多大。</li><li>每个缓冲区的策略（ring-buffer 或 stop-when-full）。</li><li>启用哪些数据源。</li><li>每个数据源的配置。由配置的每个数据源生成的数据的目标缓冲区。</li></ul></li><li>启用和禁用跟踪服务。</li><li>读取跟踪缓冲区数据<ul><li>通过 IPC 通道流式传输数据。</li><li>将文件描述符传递给服务，并指示它定期将跟踪缓冲区保存到文件中。</li></ul></li></ul><h3 id="42-关于-trace-config-文件的编写"><a class="anchor" href="#42-关于-trace-config-文件的编写">#</a> 4.2 关于 Trace config 文件的编写</h3><p>通过对 1.1 里内容的阅读，相信你一定对这个配置文件有了一定的了解。对于这个文件的编写，可以参照给定的示例手动编写，也可以用 Perfetto UI 网站生成。以下介绍一下，用 Perfetto UI 网站生成自定义 Config 文件的方法，这是最简便的：</p><ol><li><p>打开<span class="exturl" data-url="aHR0cHM6Ly91aS5wZXJmZXR0by5kZXYvIyEv"> Perfetto UI</span> 界面，点击左侧的 &quot;Record new trace&quot;，你会看到许多配置界面。你可以根据需要选择跟踪点。如图：</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-10_20-04-08_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-10_20-04-08_.png"></p></li><li><p>选择目标平台 (Target platform) 为 Linux，点击 &quot;Trace command&quot; 就可以生成一下内容：</p><p><img data-src="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-11_11-16-41_.png" alt="Perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%206a1dba7b6779420db0b26de2ce5b0a4b/2021-03-11_11-16-41_.png"></p><p>有两种方法使用它：</p><ol><li>直接将其复制到终端执行，但是需要先配置一下环境变量：</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/home/linux/perfetto/out/linux_clang_release/:<span class="token environment constant">$PATH</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 或者使用这个</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/home/linux/perfetto/out/linux_clang_debug/:<span class="token environment constant">$PATH</span></pre></td></tr></table></figure><ol start="2"><li>或者将两个 EOF 之间的内容复制到自己的配置文件中。</li></ol></li></ol><h3 id="43-通过命令行启动"><a class="anchor" href="#43-通过命令行启动">#</a> 4.3 通过命令行启动</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./perfetto --txt -c <span class="token operator">&lt;</span>自己后缀为.cfg的配置文件的绝对路径<span class="token operator">></span> -o /tmp/trace</pre></td></tr></table></figure><ul><li><ul><li><ul><li>txt 选项指示配置文件是 PBTX（ProtoBuf TeXtual representation) 格式的文件。</li></ul></li></ul></li><li>-c 选项用来指定配置文件。</li><li>-o 选项指定 trace 信息输出到的文件。</li></ul><h2 id="5-查看追踪信息"><a class="anchor" href="#5-查看追踪信息">#</a> 5. 查看追踪信息</h2><p>在 <span class="exturl" data-url="aHR0cHM6Ly91aS5wZXJmZXR0by5kZXYvIyEv">perfetto ui</span> 界面打开刚才生成的追踪文件（/tmp/trace)，就可以直观地查看了。</p><p>你可以点击左侧的 &quot;Metrics and auditors&quot; 菜单里的子菜单，以显示更多信息帮助理解。</p><ul><li>Perfettoo UI 的操作快捷键<ul><li><p>键盘控制：</p><p>w/s	放大 / 缩小</p><p>a/d	向左 / 向右平移</p></li><li><p>鼠标控制：</p><p>点击 选择活动</p><p>Ctrl + 滚轮 放大 / 缩小</p><p>单击并拖动 选择区域</p><p>Shift + 单击 + 拖动 向左 / 向右平移</p></li><li><p>其他:</p><p>F （选择事件） 滚动 + 缩放到当前选择</p><p>m （选择事件或区域） 标记区域（临时）</p><p>Shift + m （选择事件或区域） 标记区域（永久）</p><p>[/] （选择事件） 选择通过流连接的下一个 / 上 一个切片。如果有多个流程，则选择一个重点突出（粗体）的流程。</p><p>Ctrl + [/] （选择事件） 将焦点切换到另一个流程</p></li></ul></li></ul></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-08-21 20:49:55" itemprop="dateModified" datetime="2022-08-21T20:49:55+08:00">2022-08-21</time> </span><span id="Perfetto/" class="item leancloud_visitors" data-flag-title="Perfetto" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Yang 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Yang 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Yang 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Yang <i class="ic i-at"><em>@</em></i>苍穹录</li><li class="link"><strong>本文链接：</strong> <a href="http://yoursite.com/Perfetto/" title="Perfetto">http://yoursite.com/Perfetto/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/hello-world/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;c2.im5i.com&#x2F;2022&#x2F;09&#x2F;12&#x2F;52ont.jpg" title="Hello World"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>Hello World</h3></a></div><div class="item right"><a href="/%E6%96%B0%E7%96%86/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;c2.im5i.com&#x2F;2022&#x2F;09&#x2F;12&#x2F;52jT7.jpg" title="未命名"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>未命名</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#perfetto%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">1.</span> <span class="toc-text">Perfetto 性能分析工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%9E%84%E5%BB%BAperfetto"><span class="toc-number">3.</span> <span class="toc-text">2. 构建 Perfetto</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%B5%8B%E8%AF%95perfetto"><span class="toc-number">4.</span> <span class="toc-text">3. 测试 Perfetto</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#31-%E4%B8%80%E9%94%AE%E5%BC%8F-tmux-%E8%84%9A%E6%9C%AC"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 一键式 tmux 脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-%E6%89%8B%E5%8A%A8%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 手动运行服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8perfetto"><span class="toc-number">5.</span> <span class="toc-text">4. 使用 Perfetto</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8traced-service"><span class="toc-number">5.1.</span> <span class="toc-text">1. 启动 traced service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E6%8F%8F%E8%BF%B0"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1 描述：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E5%AE%83%E5%85%B7%E6%9C%89%E4%BB%A5%E4%B8%8B%E5%8A%9F%E8%83%BD"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2 它具有以下功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%90%AF%E5%8A%A8-traced_probes"><span class="toc-number">5.2.</span> <span class="toc-text">2. 启动 traced_probes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8%E4%BD%A0%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.3.</span> <span class="toc-text">3. 启动你的程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E7%A8%8B%E5%BA%8F%E7%BC%96%E5%86%99%E8%AF%BB%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%80%83%E8%BF%99%E9%87%8C"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1 程序编写（读的时候可以参考这里）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8consumer"><span class="toc-number">5.4.</span> <span class="toc-text">4. 启动 Consumer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E6%8F%8F%E8%BF%B0"><span class="toc-number">5.4.1.</span> <span class="toc-text">4.1 描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E5%85%B3%E4%BA%8E-trace-config-%E6%96%87%E4%BB%B6%E7%9A%84%E7%BC%96%E5%86%99"><span class="toc-number">5.4.2.</span> <span class="toc-text">4.2 关于 Trace config 文件的编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%90%AF%E5%8A%A8"><span class="toc-number">5.4.3.</span> <span class="toc-text">4.3 通过命令行启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E8%BF%BD%E8%B8%AA%E4%BF%A1%E6%81%AF"><span class="toc-number">5.5.</span> <span class="toc-text">5. 查看追踪信息</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Yang" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Yang</p><div class="description" itemprop="description">合抱之木，生于毫末；九层之塔，起于垒土。</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">3</span> <span class="name">文章</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NodWFuZy1aaQ==" title="https:&#x2F;&#x2F;github.com&#x2F;Shuang-Zi"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>朋友</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/hello-world/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/%E6%96%B0%E7%96%86/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/hello-world/" title="Hello World">Hello World</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/%E6%96%B0%E7%96%86/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/Perfetto/" title="Perfetto">Perfetto</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Yang @ 双子红械</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">12k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">11 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Perfetto/",favicon:{show:"暗星",hide:"黑洞"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>